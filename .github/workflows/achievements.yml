name: ğŸš¦ SignSprinters Achievement Badges

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
    types: [closed]
  workflow_dispatch:

permissions:
  contents: write
  actions: read

jobs:
  update-achievements:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)

    steps:
    - name: ğŸš€ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: ğŸ” Debug Environment
      run: |
        echo "Event name: ${{ github.event_name }}"
        echo "Repository: ${{ github.repository }}"
        echo "Branch: ${{ github.ref }}"
        echo "Actor: ${{ github.actor }}"
        echo "Working directory: $(pwd)"
        echo "Files in root:"
        ls -la
        echo "Git status:"
        git status || echo "Git status unavailable"
        echo "Commit count:"
        git rev-list --count HEAD || echo "Commit count unavailable"

    - name: ğŸ“ Create Enhanced Achievement Script
      run: |
        mkdir -p .github/scripts
        cat > .github/scripts/enhanced-badges.js << 'EOF'
        const fs = require('fs');
        const path = require('path');
        const { execSync } = require('child_process');

        const achievements = {
          'traffic-pioneer': { name: 'Traffic Pioneer', icon: 'ğŸš¦', color: 'FF6B35', desc: 'First commit' },
          'python-driver': { name: 'Python Driver', icon: 'ğŸ', color: '3776AB', desc: '5+ Python files' },
          'ml-engineer': { name: 'ML Engineer', icon: 'ğŸ¤–', color: 'FF4081', desc: 'ML model files' },
          'data-scientist': { name: 'Data Scientist', icon: 'ğŸ“Š', color: '2196F3', desc: 'Dataset files' },
          'doc-master': { name: 'Doc Master', icon: 'ğŸ“š', color: '4CAF50', desc: '3+ docs' },
          'test-engineer': { name: 'Test Engineer', icon: 'ğŸ§ª', color: 'FF9800', desc: 'Test files' },
          'commit-champion': { name: 'Commit Champion', icon: 'ğŸ†', color: 'FFD700', desc: '25+ commits' },
          'web-wizard': { name: 'Web Wizard', icon: 'ğŸŒ', color: '61DAFB', desc: 'HTML/CSS/JS files' },
          'config-master': { name: 'Config Master', icon: 'âš™ï¸', color: '9C27B0', desc: 'Config files' }
        };

        function safeExec(command, fallback = '0') {
          try {
            return execSync(command, { encoding: 'utf8', stdio: ['ignore', 'pipe', 'ignore'] }).trim() || fallback;
          } catch (error) {
            console.log(`Command failed: ${command}`);
            return fallback;
          }
        }

        function countFiles(extensions) {
          let count = 0;
          extensions.forEach(ext => {
            try {
              const cmd = ext.startsWith('.') 
                ? `find . -name "*${ext}" -type f | grep -v node_modules | grep -v .git | wc -l`
                : `find . -name "*${ext}*" -type f | grep -v node_modules | grep -v .git | wc -l`;
              
              const result = execSync(cmd, { encoding: 'utf8' });
              count += parseInt(result.trim()) || 0;
            } catch (err) {
              console.log(`Error counting ${ext}:`, err.message);
            }
          });
          return count;
        }

        function analyzeRepo() {
          console.log('ğŸ” Analyzing repository...');
          
          const stats = {
            commits: parseInt(safeExec('git rev-list --count HEAD', '0')),
            pythonFiles: countFiles(['.py']),
            mlFiles: countFiles(['.pkl', '.h5', '.joblib', 'model', '.onnx', '.pt', '.pth']),
            dataFiles: countFiles(['.csv', '.json', '.xlsx', '.parquet', 'data', 'dataset']),
            docFiles: countFiles(['.md', '.rst', '.txt', 'README', 'CHANGELOG', 'LICENSE']),
            testFiles: countFiles(['test', '_test', '.test', 'spec']),
            webFiles: countFiles(['.html', '.css', '.js', '.jsx']),
            configFiles: countFiles(['.yml', '.yaml', '.toml', '.ini', 'Dockerfile', 'requirements'])
          };
          
          console.log('ğŸ“Š Stats:', JSON.stringify(stats, null, 2));
          return stats;
        }

        function checkEarned(stats) {
          const earned = [];
          if (stats.commits >= 1) earned.push('traffic-pioneer');
          if (stats.pythonFiles >= 5) earned.push('python-driver');
          if (stats.mlFiles >= 1) earned.push('ml-engineer');
          if (stats.dataFiles >= 1) earned.push('data-scientist');
          if (stats.docFiles >= 3) earned.push('doc-master');
          if (stats.testFiles >= 1) earned.push('test-engineer');
          if (stats.commits >= 25) earned.push('commit-champion');
          if (stats.webFiles >= 3) earned.push('web-wizard');
          if (stats.configFiles >= 2) earned.push('config-master');
          return earned;
        }

        function generateBadgeSection(earned, stats) {
          let section = '\n## ğŸ† SignSprinters Achievements\n\n';
          
          if (earned.length === 0) {
            section += 'ğŸš€ *Start coding to earn your first badge!*\n\n';
            return section;
          }
          
          section += '<div align="center">\n\n';
          earned.forEach(key => {
            const ach = achievements[key];
            const badgeUrl = `https://img.shields.io/badge/${encodeURIComponent(ach.name)}-${encodeURIComponent(ach.desc)}-${ach.color}?style=for-the-badge`;
            section += `![${ach.name}](${badgeUrl})\n`;
          });
          section += '\n</div>\n\n';
          
          section += '### ğŸ“Š Stats\n\n';
          section += `- ğŸ Python Files: **${stats.pythonFiles}**\n`;
          section += `- ğŸ¤– ML Files: **${stats.mlFiles}**\n`;
          section += `- ğŸ“Š Data Files: **${stats.dataFiles}**\n`;
          section += `- ğŸ“š Doc Files: **${stats.docFiles}**\n`;
          section += `- ğŸ§ª Test Files: **${stats.testFiles}**\n`;
          section += `- ğŸŒ Web Files: **${stats.webFiles}**\n`;
          section += `- âš™ï¸ Config Files: **${stats.configFiles}**\n`;
          section += `- ğŸ“ Commits: **${stats.commits}**\n\n`;
          
          const progress = Math.round((earned.length / Object.keys(achievements).length) * 100);
          section += `**Progress: ${earned.length}/${Object.keys(achievements).length} badges (${progress}%)**\n\n`;
          section += `*Updated: ${new Date().toLocaleString()}*\n\n`;
          
          return section;
        }

        function main() {
          try {
            console.log('ğŸš¦ Starting SignSprinters Badge System...');
            
            const stats = analyzeRepo();
            const earned = checkEarned(stats);
            
            console.log(`ğŸ† Earned ${earned.length} badges:`, earned);
            
            // Save data
            const data = { earned, stats, updated: new Date().toISOString() };
            fs.mkdirSync('.github', { recursive: true });
            fs.writeFileSync('.github/achievements.json', JSON.stringify(data, null, 2));
            
            // Update README
            let readme = fs.existsSync('README.md') ? 
              fs.readFileSync('README.md', 'utf8') : 
              '# SignSprinters Traffic Sign Recognition\n\nWelcome to our project!\n';
            
            // More precise replacement - look for the exact achievements section
            const achievementRegex = /## ğŸ† SignSprinters Achievements[\s\S]*?(?=## [^ğŸ†]|\n---|\n#(?!#)|$)/g;
            readme = readme.replace(achievementRegex, generateBadgeSection(earned, stats).substring(1)); // Remove leading newline
            
            // If no achievements section exists, add it before Getting Started
            if (!readme.includes('## ğŸ† SignSprinters Achievements')) {
              const insertPoints = [
                '## Getting Started',
                '### Prerequisites',
                '## Installation',
                '## Usage'
              ];
              
              let inserted = false;
              for (const point of insertPoints) {
                if (readme.includes(point)) {
                  readme = readme.replace(point, generateBadgeSection(earned, stats) + point);
                  inserted = true;
                  break;
                }
              }
              
              if (!inserted) {
                readme += generateBadgeSection(earned, stats);
              }
            }
            
            fs.writeFileSync('README.md', readme);
            console.log('âœ… Badges updated successfully!');
            
          } catch (error) {
            console.error('âŒ Error:', error.message);
            process.exit(1);
          }
        }

        main();
        EOF

    - name: ğŸ† Generate Badges
      run: |
        echo "ğŸš€ Running enhanced badge generator..."
        node .github/scripts/enhanced-badges.js

    - name: ğŸ” Verify Generated Files
      run: |
        echo "ğŸ“ Checking generated files:"
        if [ -f ".github/achievements.json" ]; then
          echo "âœ… achievements.json created"
          echo "ğŸ“„ Content preview:"
          head -20 .github/achievements.json
        else
          echo "âŒ achievements.json not found"
        fi
        
        echo ""
        echo "ğŸ“– README.md achievements section:"
        if grep -A 10 "## ğŸ† SignSprinters Achievements" README.md; then
          echo "âœ… Achievements section found in README"
        else
          echo "âš ï¸ Achievements section not found in README"
        fi

    - name: ğŸ” Check Changes
      id: changes
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "has_changes=false" >> $GITHUB_OUTPUT
          echo "âœ… No changes to commit"
        else
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "ğŸ“ Changes detected:"
          git diff --staged --name-only
          echo "ğŸ“‹ Diff summary:"
          git diff --staged --stat
        fi

    - name: ğŸ“ Commit Changes
      if: steps.changes.outputs.has_changes == 'true'
      run: |
        git config --local user.name "ğŸš¦ SignSprinters Bot"
        git config --local user.email "bot@signsprinters.dev"
        git commit -m "ğŸ† Update SignSprinters achievements [automated]

        ğŸ“Š Achievements updated automatically
        ğŸ¤– Generated by GitHub Actions
        â° $(date)"
        git push
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“Š Final Report
      run: |
        echo "ğŸ‰ SignSprinters Achievement Update Complete!"
        echo ""
        if [ -f ".github/achievements.json" ]; then
          echo "ğŸ“ˆ Achievement Summary:"
          node -e "
            const data = JSON.parse(require('fs').readFileSync('.github/achievements.json', 'utf8'));
            console.log(\`   ğŸ† Badges Earned: \${data.earned.length}\`);
            console.log(\`   ğŸ“Š Total Commits: \${data.stats.commits}\`);
            console.log(\`   ğŸ Python Files: \${data.stats.pythonFiles}\`);
            console.log(\`   ğŸ“š Doc Files: \${data.stats.docFiles}\`);
            console.log(\`   ğŸ§ª Test Files: \${data.stats.testFiles}\`);
            console.log(\`   â° Last Updated: \${new Date(data.updated).toLocaleString()}\`);
          "
        else
          echo "âš ï¸ Achievement data not available"
        fi
